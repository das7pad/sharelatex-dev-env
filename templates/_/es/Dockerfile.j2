{% from 'macros/header.j2' import header with context %}
{{ header('#') }}

FROM node:{{ node_version }}

CMD ["node", "--expose-gc", "app.js"]

{% if has_entrypoint %}
ENTRYPOINT ["/bin/sh", "entrypoint.sh"]
{% endif %}

WORKDIR /app

COPY docker_cleanup.sh /

{% if has_install_deps %}
COPY install_deps.sh /app/
RUN /app/install_deps.sh
{% endif %}

COPY package.json package-lock.json /app/

RUN /docker_cleanup.sh npm ci

{% block pre_copy %}
{% endblock %}

COPY . /app

RUN /docker_cleanup.sh make build_app

{% if has_setup_env %}
RUN /app/setup_env.sh
{% endif -%}

{% block volumes %}
{% endblock %}

{% if not has_entrypoint %}
USER node
{% endif %}

ARG RELEASE
ARG COMMIT
ENV \
    SERVICE_NAME="{{ name }}" \
    RELEASE=${RELEASE} \
    SENTRY_RELEASE=${RELEASE} \
    COMMIT=${COMMIT}
