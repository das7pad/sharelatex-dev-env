{% from 'macros/header.j2' import header with context %}
{{ header('//') }}

{% set docker_image_app = (
    name + ':$BRANCH_NAME-$BUILD_NUMBER'
  ) %}
{% set docker_image_app_origin = (
    '$SHARELATEX_DOCKER_REPOS/' + docker_image_app
  ) %}
{% set docker_image_app_origin_branch = (
    '$SHARELATEX_DOCKER_REPOS/' + name + ':$BRANCH_NAME'
  ) %}
{% set docker_image_app_origin_branch_dev = (
    '$SHARELATEX_DOCKER_REPOS/' + name + ':dev'
  ) %}
{% set agent_label_build = 'sharelatex && docker_builder' %}
{% set agent_label_test = 'sharelatex' %}
pipeline {
  agent none
  environment {
    DOCKER_COMPOSE_FLAGS = "-f docker-compose.ci.yml"
    IMAGE_CI = "ci/{{ docker_image_app }}"
    IMAGE_NODE = 'node:{{ node_version }}'
  }

  stages {
    stage('Fan Out 1') {
      parallel {
{% block lint %}
        stage('Lint') {
          agent {
            label '{{ agent_label_test }}'
          }
          steps {
            sh 'make lint'
          }
        }

        stage('Formatting') {
          agent {
            label '{{ agent_label_test }}'
          }
          steps {
            sh 'make format'
          }
        }

{% endblock %}
        stage('App Image') {
          agent {
            label '{{ agent_label_build }}'
          }
          stages {
            stage('Prepare environment') {
              stages {
                stage('Pull node image') {
                  steps {
                    sh 'docker pull $DOCKER_REGISTRY/$IMAGE_NODE'
                    sh 'docker tag $DOCKER_REGISTRY/$IMAGE_NODE $IMAGE_NODE'
                  }
                }
                stage('Clean Previous artifacts') {
                  steps {
                    sh 'make clean_output'
                    sh 'git clean -xdf'
                  }
                }
                stage('Pull Cache') {
                  environment {
                    IMAGE_BRANCH = "{{ docker_image_app_origin_branch }}"
                    IMAGE_BRANCH_DEV = "{{ docker_image_app_origin_branch_dev }}"
                    IMAGE_CACHE_HOT_DEV_DEPS = "$IMAGE_BRANCH-dev-deps"
                    IMAGE_CACHE_COLD = "$IMAGE_BRANCH_DEV-dev-deps"
                    IMAGE_CACHE_CI_DEV_DEPS = "$IMAGE_CI-dev-deps-cache"
                  }
                  steps {
                    sh '''
                      docker pull $IMAGE_CACHE_HOT_DEV_DEPS \
                      && docker tag \
                            $IMAGE_CACHE_HOT_DEV_DEPS \
                            $IMAGE_CACHE_CI_DEV_DEPS \
                      || (docker pull $IMAGE_CACHE_COLD \
                      && docker tag \
                            $IMAGE_CACHE_COLD \
                            $IMAGE_CACHE_CI_DEV_DEPS) \
                      || echo 'build cache not available'
                    '''
                  }
                  post {
                    cleanup {
                      sh '''
                        docker rmi --force \
                          $IMAGE_CACHE_HOT_DEV_DEPS \
                          $IMAGE_CACHE_COLD \
                      '''
                    }
                  }
                }
              }
            }

            stage('Build') {
              steps {
                sh 'make build'
              }
            }

            stage('Push dev-deps') {
              environment {
                IMAGE_BRANCH = "{{ docker_image_app_origin_branch }}"
                IMAGE_CACHE_HOT_DEV_DEPS = "$IMAGE_BRANCH-dev-deps"
              }
              steps {
                sh 'docker tag $IMAGE_CI-dev-deps $IMAGE_CACHE_HOT_DEV_DEPS'
                sh 'docker push $IMAGE_CACHE_HOT_DEV_DEPS'
              }
              post {
                cleanup {
                  sh 'docker rmi --force $IMAGE_CACHE_HOT_DEV_DEPS'
                }
              }
            }

            stage('Push dev') {
              environment {
                IMAGE = "{{ docker_image_app_origin }}"
              }
              steps {
                sh 'docker tag $IMAGE_CI-dev $IMAGE-dev'
                sh 'docker push $IMAGE-dev'
              }
              post {
                cleanup {
                  sh 'docker rmi --force $IMAGE-dev'
                }
              }
            }
          }
          post {
            cleanup {
              sh 'make clean_ci'
            }
          }
        }
      }
    }

    stage('Fan out 2') {
      parallel {
{% if has_unit_tests %}
        stage('Unit Tests') {
          agent {
            label '{{ agent_label_test }}'
          }
          environment {
            SUFFIX = 'test-unit'
            IMAGE = "{{ docker_image_app_origin }}"
          }
          steps {
            sh 'docker pull $IMAGE-dev'
            sh 'docker tag $IMAGE-dev $IMAGE_CI-$SUFFIX'
            sh 'mkdir --parents --mode=777 output'
            sh 'BUILD_NUMBER="$BUILD_NUMBER-$SUFFIX" make test_unit'
          }
          post {
            always {
              xunit(tools: [JUnit(pattern: 'output/unit.xml')])
            }
            cleanup {
              sh 'make clean_output'
              sh 'docker rmi --force $IMAGE-dev $IMAGE_CI-$SUFFIX'
            }
          }
        }
{% endif %}

{% if has_acceptance_tests %}
        stage('App Acceptance Tests') {
{% if name == 'clsi' %}
          agent {
            label '{{ agent_label_test }} && docker_socket_access'
          }
          environment {
            // https://github.com/das7pad/sharelatex-docker-images.git
            TEXLIVE_IMAGE = "$SHARELATEX_DOCKER_REPOS/texlive:2017.1-full"
            PULL_TEXLIVE_BEFORE_RUN = "true"
            SUFFIX = 'test-acceptance'
            IMAGE = "{{ docker_image_app_origin }}"
          }
{% else %}
          agent {
            label '{{ agent_label_test }}'
          }
          environment {
            SUFFIX = 'test-acceptance'
            IMAGE = "{{ docker_image_app_origin }}"
          }
{% endif %}
          steps {
            sh 'docker pull $IMAGE-dev'
            sh 'docker tag $IMAGE-dev $IMAGE_CI-$SUFFIX'
            sh 'mkdir --parents --mode=777 output'
            sh 'BUILD_NUMBER="$BUILD_NUMBER-$SUFFIX" make test_acceptance_app'
          }
          post {
            always {
              xunit(tools: [JUnit(pattern: 'output/acceptance.xml')])
            }
            cleanup {
              sh 'make clean_output'
              sh 'make clean_test_acceptance_app'
              sh 'docker rmi --force $IMAGE-dev $IMAGE_CI-$SUFFIX'
            }
          }
        }
{% endif %}

{% if has_frontend_tests %}
        stage('Frontend Tests') {
          agent {
            label '{{ agent_label_test }}'
          }
          environment {
            SUFFIX = 'test-frontend'
            IMAGE = "{{ docker_image_app_origin }}"
          }
          steps {
            sh 'docker pull $IMAGE-dev'
            sh 'docker tag $IMAGE-dev $IMAGE_CI-$SUFFIX'
            sh 'mkdir --parents --mode=777 output'
            sh '''
              BUILD_NUMBER="$BUILD_NUMBER-$SUFFIX" make test_frontend_build_run
            '''
          }
          post {
            always {
              xunit(tools: [JUnit(pattern: 'output/frontend.xml')])
            }
            cleanup {
              sh 'make clean_output'
              sh 'make clean_test_frontend'
              sh 'docker rmi --force $IMAGE-dev $IMAGE_CI-$SUFFIX'
            }
          }
        }
{% endif %}

{% if has_modules %}
        stage('Module Acceptance Tests') {
          agent {
            label '{{ agent_label_test }}'
          }
          environment {
            SUFFIX = 'test-modules'
            IMAGE = "{{ docker_image_app_origin }}"
          }
          steps {
            sh 'docker pull $IMAGE-dev'
            sh 'docker tag $IMAGE-dev $IMAGE_CI-$SUFFIX'
            sh 'mkdir --parents --mode=777 output'
            sh '''
              BUILD_NUMBER="$BUILD_NUMBER-$SUFFIX" \
              make test_acceptance_modules_run_ci
            '''
          }
          post {
            always {
              xunit(tools: [JUnit(pattern: 'output/module_*.xml')])
            }
            cleanup {
              sh 'make clean_output'
              sh 'make clean_test_acceptance_modules'
              sh 'docker rmi --force $IMAGE-dev $IMAGE_CI-$SUFFIX'
            }
          }
        }
{% endif %}

{% set label = (
        ('Webpack and ' if has_webpack_config_js else '')
        + 'Production build'
      ) %}
        stage('{{ label }}') {
          agent {
            label '{{ agent_label_build }}'
          }
          environment {
            IMAGE = "{{ docker_image_app_origin }}"
          }
          stages {
{% if has_webpack_config_js %}
            stage('Webpack'){
              stages {
                stage('Build webpack') {
                  steps {
                    sh 'docker pull $IMAGE-dev'
                    sh 'docker tag $IMAGE-dev $IMAGE_CI-dev'
                    sh 'make build_webpack'
                  }
                  post {
                    cleanup {
                      sh 'docker rmi --force $IMAGE-dev $IMAGE_CI-dev'
                    }
                  }
                }
                stage('archive public') {
                  steps {
                    sh '''
                      docker run \
                        --rm \
                        --volume $PWD/compress.sh:/compress.sh \
                        --workdir /app/public \
                        --entrypoint sh \
                        $IMAGE_CI-webpack \
                          -c '/compress.sh && tar --create .' \
                      | xz -9e \
                      > public.tar.xz
                    '''
                    archiveArtifacts(artifacts: 'public.tar.xz')
                  }
                  post {
                    cleanup {
                      sh 'rm -f public.tar.xz'
                    }
                  }
                }
              }
            }

{% endif %}
            stage('Production build') {
              environment {
                IMAGE_BRANCH = "{{ docker_image_app_origin_branch }}"
                IMAGE_BRANCH_DEV = "{{ docker_image_app_origin_branch_dev }}"
              }
              stages {
                stage('Pull production cache') {
                  steps {
                    sh '''
                      docker pull $IMAGE_BRANCH \
                      && docker tag $IMAGE_BRANCH $IMAGE_CI-prod-cache \
                      || (docker pull $IMAGE_BRANCH_DEV \
                      && docker tag $IMAGE_BRANCH_DEV $IMAGE_CI-prod-cache) \
                      || echo 'no prod layer build cache available'
                    '''
                  }
                  post {
                    cleanup {
                      sh '''
                        docker rmi --force \
                          $IMAGE_BRANCH \
                          $IMAGE_BRANCH_DEV \
                      '''
                    }
                  }
                }
                stage('Build production') {
                  steps {
                    sh 'docker pull $IMAGE-dev'
                    sh 'docker tag $IMAGE-dev $IMAGE_CI-dev'
                    sh 'make build_prod'
                  }
                  post {
                    cleanup {
                      sh 'docker rmi --force $IMAGE-dev $IMAGE_CI-dev'
                    }
                  }
                }
                stage('docker push') {
                  steps {
                    sh 'docker tag $IMAGE_CI-prod $IMAGE'
                    sh 'docker push $IMAGE'
                    sh 'docker tag $IMAGE $IMAGE_BRANCH'
                    sh 'docker push $IMAGE_BRANCH'
                  }
                  post {
                    cleanup {
                      sh '''
                        docker rmi --force \
                          $IMAGE \
                          $IMAGE_BRANCH \
                      '''
                    }
                  }
                }
              }
            }
          }
          post {
            cleanup {
              sh 'make clean_ci'
            }
          }
        }
      }
    }
  }
}
